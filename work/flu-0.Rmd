---
title: "Working analysis: survey weights"
output: 
  html_document:
    fig_height: 3
    fig_width: 5
    highlight: tango
    keep_md: yes
    theme: cosmo
    toc: yes
    toc_depth: 4
fontsize: 10pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, tidy = F, size = "small")
#setwd("~/git/banana-phone/work")
rm(list = ls(all.names = TRUE))

library(dplyr)
library(tidyr)
library(ggplot2)
library(survey)
#library(mosaic)
#trellis.par.set(theme=theme.mosaic()) # change default color scheme for lattice
```

```{r load_data}
load("clean/cleaning2.RData")
data <- data2
names(data) <- old_name
rm(data2)
options(digits = 4)
```

Load some recoded variables.

```{r recode}
#source(recoding.R)
load("clean/recoding1.RData")
df <- datar

#tail(df)
```

Create a survey object with weights.

```{r}
# survey object
options(survey.lonely.psu = "adjust")
des <- svydesign(ids = ~1, weights = ~weight, data = data[is.na(data$weight) == F, ])

```


## Q1. Before receiving this survey, did you know influenza is different from the stomach flu?

```{r}
# Q1 tables
with(data, summary(Q1))  # unweighted
svytable(~Q1, design = des, round = T)  # weighted

# Q1 breakdown by gender (unweighted)
with(data, table(Q1, PPGENDER))
with(data, prop.table(table(Q1, PPGENDER), margin = 1))
```

In the unweighted dataset, more females (53.37%) answered Yes to Q1 than males (46.63%); more males (57.99%) answered No compared to females (42.01%)

```{r}
# Q1 breakdown by gender (with design + weights)
svytable(~Q1 + PPGENDER, design = des, round = T)
prop.table(svytable(~Q1 + PPGENDER, design = des), margin = 1)

# with standard errors
svyby(formula = ~Q1, by = ~PPGENDER, design = des, FUN = svymean, na.rm = T)

# prop table with SE, by gender + race
svyby(formula = ~Q1, by = ~PPGENDER + PPETHM, design = des, FUN = svymean, na.rm = T)
```

In the weighted dataset, more females (55.02%) answered Yes to Q1 than males (44.98%); more males (56.88%) answered No compared to females (43.12%).

79.37% of females answered Yes to Q1; 0.2063 said No
70.45% of males answered Yes to Q1; 0.2955 said No


Apply survey design + weights for Q2.

```{r}
# glm + design weights
options(survey.lonely.psu = "adjust")
des2 <- svydesign(ids = ~1, weights = ~weight, data = df)

# Q2: being sick, by female gender
m1 = svyglm(sick ~ female, des2, family = binomial())
summary(m1)
# odds ratios
exp(coefficients(m1))

# Q2: being sick, by male gender
m = svyglm(sick ~ PPGENDER, des2, family = binomial())
summary(m)
# odds ratios
exp(coefficients(m))

# Q2: being sick, by ethnicity
m2 = svyglm(sick ~ PPETHM, des2, family = binomial())
summary(m2)
exp(coefficients(m2))  # odds ratios

# same as above, but binomial
m = svyglm(sick ~ white+black+hispanic+otherrace+mixedrace, des2, family = binomial())
summary(m)
exp(coefficients(m))  # oods ratios

```

Q2. Have you had an illness with influenza-like symptoms since August 2015?

```{r}
# Q2 by gender
with(data, table(Q2, PPGENDER))
# without weights
fit1 <- glm(sick ~ PPGENDER, data = df, family = binomial())
summary(fit1)
exp(coefficients(fit1))

contrasts(df$sick)
contrasts(data$PPGENDER)
```

Q13. getting the flu vaccine

```{r}
# use data = df, with recodes
df$vax <- recode(data$Q13, "'Yes, every year' = 1; 'Yes, some years' = 1; NA = NA; else = 0")
summary(df$vax)

## glm + design weights
options(survey.lonely.psu = "adjust")
des2 <- svydesign(ids = ~1, weights = ~weight, data = df)

# getting sick ~ getting vaccine
m3 = svyglm(sick ~ vax, des2, family = binomial)
summary(m3)
exp(coefficients(m3))
exp(m3$coef[2])

# tables with weights
svytable(~vax + sick, design = des2, round = T)
prop.table(svytable(~vax + sick, design = des2), margin = 2)


```

Other questions with design + weights.

```{r}





```


```{r}
# count total number of unweighted records
#nrow(data)
#unwtd.count(~one, des)

# by gender
#svyby(~one, ~PPGENDER, des, unwtd.count)

# count the weighted number of individuals
#svytotal(~one, des)

#
#svymean(~Q1, na.rm = T, design = des)

# by sex
#svyby(
#	~Q1 ,
#	~PPGENDER ,
#	design = des ,
#	svymean, na.rm = T
#)

```



