---
title: "Working analysis: survey weights"
output: 
  html_document:
    fig_height: 3
    fig_width: 5
    highlight: tango
    keep_md: yes
    theme: cosmo
    toc: yes
    toc_depth: 4
fontsize: 10pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, tidy = F, size = "small")
rm(list = ls(all.names = TRUE))

library(dplyr)
library(tidyr)
library(ggplot2)
library(survey)
library(car)
library(memisc)
#library(mosaic)
#trellis.par.set(theme=theme.mosaic()) # change default color scheme for lattice
```

```{r load-data}
load("clean/cleaning2.RData")
data <- data2
names(data) <- old_name
rm(data2)
```

Load some recoded variables.

```{r recoded-data}
#source(recoding.R)
load("clean/recoding1.RData")
df <- datar
#tail(df)
```

Create a survey object with weights.

```{r survey-object}
# survey object
options(digits = 4)
options(survey.lonely.psu = "adjust")
des <- svydesign(ids = ~1, weights = ~weight, data = data[is.na(data$weight) == F, ])
#summary(des)
```

## Q1. Before receiving this survey, did you know influenza is different from the stomach flu?

> Comparing sex ratios in the unweighted and weighted data frames for Q1.

```{r q1}
with(data, addmargins(table(Q1, PPGENDER)))  # unweighted Q1
svytable(~Q1 + PPGENDER, design = des, round = T)  # weighted Q1

with(data, prop.table(table(Q1, PPGENDER), margin = 1))  # unweighted prop
prop.table(svytable(~Q1 + PPGENDER, design = des), margin = 1)  # weighted prop
```

In the unweighted data frame, more females (53.37%) answered Yes to Q1 than males (46.63%); more males (57.99%) answered No compared to females (42.01%).  
In the weighted data frame, 55.02% of females answered Yes; males = 44.98%; more males (56.88%) answered No compared to females (43.12%).  

```{r q1}
# table above with standard errors
svyby(formula = ~Q1, by = ~PPGENDER, design = des, FUN = svymean, na.rm = T)

# prop table with SE, by gender + race
svyby(formula = ~Q1, by = ~PPGENDER + PPETHM, design = des, FUN = svymean, na.rm = T)

# out of all females and males
prop.table(svytable(~Q1 + PPGENDER, design = des), margin = 2)
```
Out of all females and males:  
79.37% of females answered Yes to Q1; 0.2063 said No  
70.45% of males answered Yes to Q1; 0.2955 said No  

***

Apply survey design + weights for Q2.  
Note: df contains recoded variables  

```{r}
# glm + design weights
options(survey.lonely.psu = "adjust")
des2 <- svydesign(ids = ~1, weights = ~weight, data = df)

# Q2: being sick, by female gender
m1 <- svyglm(sick ~ female, des2, family = quasibinomial())
summary(m1)
# odds ratios
(or1 <- exp(coefficients(m1)))

# Q2: being sick, by male gender
m2 <- svyglm(sick ~ PPGENDER, des2, family = quasibinomial())
summary(m2)
# odds ratios
(or2 <- exp(coefficients(m2)))

# Q2: being sick, by ethnicity
m3 <- svyglm(sick ~ PPETHM, des2, family = quasibinomial())
summary(m3)
(or3 <- exp(coefficients(m3)))  # odds ratios

# same as above, but binomial -- remove reference variable (white)
m4 <- svyglm(sick ~ black+hispanic+otherrace+mixedrace, des2, family = quasibinomial())
summary(m4)
or4 <- exp(coefficients(m4))  # odds ratios

```

Odds ratios for being sick compared to:  
  - males: `r or1[2]`  
  - females: `r or2[2]`  
  - white people: `r or4`  
  

```{r}
# adding variables to model with weights
a1 <- svyglm(sick ~ PPGENDER, des2, family = quasibinomial())
a2 <- update(a1, ~ . + PPETHM)
a3 <- update(a2, ~ . + income)

# memisc
mtable(a1, a2, a3)

```



## Q2. Have you had an illness with influenza-like symptoms since August 2015?

Without weights:  

```{r}
# Q2 by gender
with(data, table(Q2, PPGENDER))
# without weights
fit1 <- glm(sick ~ PPGENDER, data = df, family = binomial())
summary(fit1)
(q2.or <- exp(coefficients(fit1)))
#contrasts(df$sick)
#contrasts(data$PPGENDER)
```

Unweighted OR for being sick last year = `r q2.or[2]` compared to females.  


## Q13. getting the flu vaccine

```{r}
# use data = df, with recodes
df$vax <- recode(data$Q13, "'Yes, every year' = 1; 'Yes, some years' = 1; NA = NA; else = 0")

# check that the newly recoded column makes sense
str(df$vax)
str(data$Q13)
summary(data$Q13)
summary(df$vax)

# glm + design weights
options(survey.lonely.psu = "adjust")
des2 <- svydesign(ids = ~1, weights = ~weight, data = df)

# getting sick ~ getting vaccine
m3 <- svyglm(sick ~ vax, des2, family = quasibinomial)
summary(m3)
exp(coefficients(m3)[2])
```

OR for being sick last year for those receiving vaccine = `r exp(coefficients(m3)[2])`

```{r}
# tables with weights
svytable(~vax + sick, design = des2, round = T)
prop.table(svytable(~vax + sick, design = des2), margin = 2)
prop.table(svytable(~vax + sick, design = des2), margin = 1)
```

Out of those who reported being sick, 65.03% reported receiving vaccine.  
Out of those who were healthy, 58.43% received vaccine (41.57% did not).  
Vaccinated group: 78.32% report no illness.  
Unvaccinated group: 82.7% report no illness.  
  


Other questions with design + weights.
```{r}



```



