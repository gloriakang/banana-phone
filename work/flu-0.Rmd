---
title: "flu-0"
output: 
  html_document:
    css: reports/style.css
    fig_height: 3
    fig_width: 6
    highlight: tango
    keep_md: yes
    theme: cosmo
    toc: yes
    toc_depth: 4
---

*Notes: Bivariate and multivariate analyses of flu survey data with weights*  
An odds ratio is a measure of association between an exposure and an outcome. The OR represents the odds that an outcome will occur given a particular exposure, compared to the odds of the outcome occurring in the absence of that exposure.  
  
When a logistic regression is calculated, the regression coefficient (b1) is the estimated increase in the log odds of the outcome per unit increase in the value of the exposure. In other words, the exponential function of the regression coefficient (e^b1) is the odds ratio associated with a one-unit increase in the exposure.  
  
The 95% CI is used to estimate the precision of the OR. A large CI indicates a low level of precision of the OR, whereas a small CI indicates a higher precision of the OR. It is important to note however, that unlike the p value, the 95% CI does not report a measureâ€™s statistical significance. In practice, the 95% CI is often used as a proxy for the presence of statistical significance if it does not overlap the null value (OR=1). Nevertheless, it would be inappropriate to interpret an OR with 95% CI that spans the null value as indicating evidence for lack of association between the exposure and outcome.  
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, tidy = F, size = "small")
rm(list = ls(all.names = TRUE))

library(dplyr); library(tidyr); library(ggplot2)
library(survey); library(car); library(memisc)
#library(mosaic)
#trellis.par.set(theme=theme.mosaic()) # change default color scheme for lattice
```

### Load data and recoded variables.

```{r load-data}
load("clean/cleaning2.RData")
data <- data2
names(data) <- old_name  # give data old names
rm(data2)

#source(recoding.R)
load("clean/recoding1.RData")
df <- datar  # df contains recoded variables
#tail(df)
```

### Create a survey object with weights.

```{r survey-object}
options(digits = 4)
options(survey.lonely.psu = "adjust")
des <- svydesign(ids = ~1, weights = ~weight, data = data[is.na(data$weight) == F, ])
#summary(des)
```

# Survey questions
## Q1. Before receiving this survey, did you know influenza is different from the stomach flu?
  
### Compare sex ratios in unweighted and weighted data frames for Q1.
  
```{r q1}
with(data, addmargins(table(Q1, PPGENDER)))  # unweighted Q1
svytable(~Q1 + PPGENDER, design = des, round = T)  # weighted Q1

(u <- with(data, prop.table(table(Q1, PPGENDER), margin = 1))*100)  # unweighted prop
(w <- prop.table(svytable(~Q1 + PPGENDER, design = des), margin = 1)*100)  # weighted prop
```

In the unweighted data frame, `r u[1]`% of females answered Yes to Q1; males = `r u[3]`%  
`r u[4]`% of males answered No; females = `r u[4]`%  
In the weighted data frame, `r w[1]`% of females answered Yes; males = `r w[3]`%;  
`r w[4]`% of males answered No; females = `r w[2]`%  
  

```{r}
# table above with standard errors
svyby(formula = ~Q1, by = ~PPGENDER, design = des, FUN = svymean, na.rm = T)

# prop table with SE, by gender + race
svyby(formula = ~Q1, by = ~PPGENDER + PPETHM, design = des, FUN = svymean, na.rm = T)

# out of all females and males
(w <- prop.table(svytable(~Q1 + PPGENDER, design = des), margin = 2)*100)
```

`r w[1]`% of females answered Yes to Q1; `r w[2]`% said No  
`r w[3]`% of males answered Yes to Q1; `r w[4]`% said No  
  
  
## Q2. Have you had an illness with influenza-like symptoms since August 2015?

### Without weights.

```{r}
# Q2 by gender
with(data, table(Q2, PPGENDER))
fit1 <- glm(sick ~ PPGENDER, data = df, family = binomial())  # unweighted
summary(fit1)
(q2.u <- exp(coefficients(fit1)))
```

In the unweighted data frame, the odds ratio of being sick as a male is `r q2.u[2]` times the odds of a female.

### Apply survey design + weights for Q2. Analyze sick vs. not sick by gender.

```{r}
# create survey object + weights
options(survey.lonely.psu = "adjust")
des2 <- svydesign(ids = ~1, weights = ~weight, data = df)  # data = df

# Q2: being sick, by female gender
m1 <- svyglm(sick ~ female, des2, family = quasibinomial())
summary(m1)
# odds ratios
(or1 <- exp(coefficients(m1)))
```

Females had `r or1[2]` odds of being sick compared to males.

```{r}
# Q2: being sick, by male gender
m2 <- svyglm(sick ~ PPGENDER, des2, family = quasibinomial())
summary(m2)
# odds ratios
(or2 <- exp(coefficients(m2)))
```

Males had `r or2[2]` odds of being sick compared to females.  

### What about by ethnicity?

```{r}
# Q2: being sick, by ethnicity
m3 <- svyglm(sick ~ PPETHM, des2, family = quasibinomial())
summary(m3)
(or3 <- exp(coefficients(m3)))  # odds ratios

# same as above, but binomial -- remove reference variable (white)
m4 <- svyglm(sick ~ black+hispanic+otherrace+mixedrace, des2, family = quasibinomial())
summary(m4)
(or4 <- exp(coefficients(m4)))  # odds ratios
```

Compared to white ethnicity, odds ratio for being sick are `r or4[2:5]` for black, hispanic, other, and 2+ mixed race groups, respectively.  
  
  
### Create and compare models for sick vs. not sick.

```{r}
# adding variables to model with weights
a1 <- svyglm(sick ~ PPGENDER, des2, family = quasibinomial())
a2 <- update(a1, ~ . + PPETHM)  # add race
a3 <- update(a2, ~ . + income)  # add income

# memisc
mtable(a1, a2, a3)
```

## Q13. Do you get an influenza vaccine?

```{r}
# use data = df, with recodes
# recode Q13 as 1 = yes always; 1 = yes sometimes; 0 = no never
str(df$vax)
str(data$Q13)

# glm + design weights
options(survey.lonely.psu = "adjust")
des2 <- svydesign(ids = ~1, weights = ~weight, data = df)

# getting sick ~ getting vaccine
m5 <- svyglm(sick ~ vax, des2, family = quasibinomial)
summary(m5)
(or5 <- exp(coefficients(m5)))
```

Those who did not receive vaccine had `r or5[2]` odds of getting sick compared to those who received the vaccine.

```{r}
# Q2 + Q13 tables with weights
svytable(~vax + sick, design = des2, round = T)  # sick = 1, not sick = 0
(t2 <- prop.table(svytable(~vax + sick, design = des2), margin = 2)* 100)
(t1 <- prop.table(svytable(~vax + sick, design = des2), margin = 1)* 100)
```

Out of those who reported being sick, `r t2[3]`% reported receiving vaccine.  
Out of those who were healthy, `r t2[1]`% received vaccine (`r t2[2]`% did not).  
Vaccinated group: `r t1[1]`% report no illness.  
Unvaccinated group: `r t1[2]`% report no illness.  
  


```{r}

```

