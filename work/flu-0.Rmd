---
title: "flu-0"
output: 
  html_document:
    css: reports/style.css
    fig_height: 3
    fig_width: 6
    highlight: tango
    keep_md: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
---

### Bivariate and multivariate analyses
  
An odds ratio is a measure of association between an exposure and an outcome. The OR represents the odds that an outcome will occur given a particular exposure, compared to the odds of the outcome occurring in the absence of that exposure.  
  
When a logistic regression is calculated, the regression coefficient (b1) is the estimated increase in the log odds of the outcome per unit increase in the value of the exposure. In other words, the exponential function of the regression coefficient (e^b1) is the odds ratio associated with a one-unit increase in the exposure.  
  
The 95% CI is used to estimate the precision of the OR. A large CI indicates a low level of precision of the OR, whereas a small CI indicates a higher precision of the OR. It is important to note however, that unlike the p value, the 95% CI does not report a measureâ€™s statistical significance. In practice, the 95% CI is often used as a proxy for the presence of statistical significance if it does not overlap the null value (OR=1). Nevertheless, it would be inappropriate to interpret an OR with 95% CI that spans the null value as indicating evidence for lack of association between the exposure and outcome.  
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, tidy = F, size = "small")
rm(list = ls(all.names = TRUE))

library(dplyr); library(tidyr); library(ggplot2)
library(survey); library(car); library(memisc)
#library(mosaic)
#trellis.par.set(theme=theme.mosaic()) # change default color scheme for lattice
```

### Load data and recoded variables.

```{r load-data}
load("clean/cleaning2.RData")
data <- data2
names(data) <- old_name  # give data old names
rm(data2)

#source(recoding.R)
load("clean/recoding1.RData")
df <- datar  # datar contains recoded variables
#tail(df)
```

### Create a survey object with weights.

```{r survey-object}
options(digits = 4)
options(survey.lonely.psu = "adjust")
des <- svydesign(ids = ~1, weights = ~weight, data = data[is.na(data$weight) == F, ])
#summary(des)
```

# Survey questions
## Q1. Before receiving this survey, did you know influenza is different from the stomach flu?
  
### Compare sex ratios in unweighted and weighted data frames for Q1.
  
```{r q1}
with(data, addmargins(table(Q1, PPGENDER)))  # unweighted Q1
svytable(~Q1 + PPGENDER, design = des, round = T)  # weighted Q1

(u <- with(data, prop.table(table(Q1, PPGENDER), margin = 1))*100)  # unweighted prop
(w <- prop.table(svytable(~Q1 + PPGENDER, design = des), margin = 1)*100)  # weighted prop
```

In the unweighted data frame, `r u[1]`% of females answered Yes to Q1; males = `r u[3]`%  
`r u[4]`% of males answered No; females = `r u[4]`%  
In the weighted data frame, `r w[1]`% of females answered Yes; males = `r w[3]`%;  
`r w[4]`% of males answered No; females = `r w[2]`%  
  
```{r}
# table above with standard errors
svyby(formula = ~Q1, by = ~PPGENDER, design = des, FUN = svymean, na.rm = T)

# prop table with SE, by gender + race
svyby(formula = ~Q1, by = ~PPGENDER + PPETHM, design = des, FUN = svymean, na.rm = T)

# out of all females and males
(w <- prop.table(svytable(~Q1 + PPGENDER, design = des), margin = 2)*100)
```

`r w[1]`% of females answered Yes to Q1; `r w[2]`% said No  
`r w[3]`% of males answered Yes to Q1; `r w[4]`% said No  
  
  
## Q2. Have you had an illness with influenza-like symptoms since August 2015?

### Without weights.

```{r}
# recode Q2
df$sick <- car::recode(datar$Q2, recodes = "'Yes' = 1; 'No' = 0; NA = NA")

# Q2 by gender
with(df, table(Q2, PPGENDER))

fit1 <- glm(sick ~ PPGENDER, data = df, family = binomial())  # unweighted
summary(fit1)
(q2.u <- exp(coefficients(fit1)))
```

In the unweighted data frame, the odds ratio of being sick as a male is `r q2.u[2]` the odds of a female.


### Apply survey design + weights for Q2. Analyze sick vs. not sick, by gender.

```{r}
# recode
df$female <- car::recode(datar$PPGENDER, recodes = "'Female' = 1; 'Male' = 0")
# create survey object + weights
options(survey.lonely.psu = "adjust")
des2 <- svydesign(ids = ~1, weights = ~weight, data = df)  # data = df

# Q2: being sick, by female gender
m1 <- svyglm(sick ~ female, des2, family = quasibinomial())
summary(m1)
# odds ratios
(or1 <- exp(coefficients(m1)))
```

In the weighted data frame, females have `r or1[2]` the odds of being sick compared to males.

```{r}
# Q2: being sick, by male gender
m2 <- svyglm(sick ~ PPGENDER, des2, family = quasibinomial())
summary(m2)
# odds ratios
(or2 <- exp(coefficients(m2)))
```

In the weighted data frame, males have `r or2[2]` the odds of being sick compared to females.  


### by ethnicity

```{r}
# Q2: being sick, by ethnicity
m3 <- svyglm(sick ~ PPETHM, des2, family = quasibinomial())
summary(m3)
(or3 <- exp(coefficients(m3)))  # odds ratios

# same as above, but binomial -- remove reference variable (white)
m4 <- svyglm(sick ~ black+hispanic+otherrace+mixedrace, des2, family = quasibinomial())
summary(m4)
(or4 <- exp(coefficients(m4)))  # odds ratios
```

Compared to white ethnicity, odds ratio for being sick are `r or4[2:5]` for black, hispanic, other, and 2+ mixed race groups, respectively.  
  
***

### Create and compare models for sick vs. not sick.

```{r}
# relevel gender and update survey object
df$PPGENDER <- relevel(datar$PPGENDER, "Male")
des2 <- svydesign(ids = ~1, weights = ~weight, data = df)

# adding variables to model with weights
a1 <- svyglm(sick ~ PPGENDER, des2, family = quasibinomial())
a2 <- update(a1, ~ . + PPETHM)  # add race
a3 <- update(a2, ~ . + work)  # add work
a4 <- update(a3, ~ . + marital)  # add marital status

# memisc: need to modify summary function
mtable(a1, a2, a3, a4)

# OR for a3
(or <- exp(coefficients(a3)))

```

When adjusting for gender, ethnicity, and work status, significant explanatory variables for being sick include being female `r or[2]` and being hispanic `r or[4]`

***

## Q13. Do you get an influenza vaccine?

```{r}
# check to make sure Q13 has been re-grouped
str(datar$Q13)  # original
str(df$q13)  # updated

# relevel q13
df$q13 <- relevel(df$q13, "No")

# update survey object
options(survey.lonely.psu = "adjust")
des2 <- svydesign(ids = ~1, weights = ~weight, data = df)

# getting sick ~ getting vaccine
m5 <- svyglm(sick ~ q13, des2, family = quasibinomial)
summary(m5)
(or5 <- exp(coefficients(m5)))
```

Those who get the vaccine had `r or5[2]` the odds of getting sick compared to those who do not get the vaccine.

```{r}
# Q2 + Q13 tables with weights
svytable(~q13 + sick, design = des2, round = T)  # sick = 1, not sick = 0
(t2 <- prop.table(svytable(~q13 + sick, design = des2), margin = 2)* 100)
(t1 <- prop.table(svytable(~q13 + sick, design = des2), margin = 1)* 100)
```

Out of those who reported being sick, `r t2[4]`% reported receiving vaccine.  
Out of those who were healthy, `r t2[3]`% received vaccine (`r t2[1]`% did not).  
Vaccinated group: `r t1[3]`% report no illness.  
Unvaccinated group: `r t1[1]`% report no illness.  
  

### Regression analysis for Q2 and Q13
Subset sick + vaccinated group. Run regression and adjust for demographic variables.

```{r}
# subset sick and vaccinated
df2 <- df %>%
  mutate(sickq13 = ifelse((sick == 1 & q13 == "Yes"), 1, 0))

df2$sickq13 <- as.factor(df2$sickq13)
str(df2$sickq13)

# table of sick and vaccine status
xtabs(~sick + q13, df2)
# 1 = sick and vaccinated, else = 0
table(df2$sickq13)

# update survey object
options(survey.lonely.psu = "adjust")
des3 <- svydesign(ids = ~1, weights = ~weight, data = df2)

m1 <- svyglm(sickq13 ~ PPGENDER, des3, family = quasibinomial())
m2 <- update(m1, ~ . + PPETHM)  # add race
m3 <- update(m2, ~ . + work)  # add work
m4 <- update(m3, ~ . + ppagecat)  # add age

# memisc, need to modify summary function
mtable(m1, m2, m3, m4)


# who is getting sick after vaccinations?
svyby(formula = ~ppagecat, by = ~sickq13, design = des3, FUN = svymean, na.rm = T)
svyby(formula = ~PPGENDER, by = ~sick + q13, design = des3, FUN = svymean, na.rm = T)

#with(df2, table(sickq13, 

```


```{r, eval=FALSE, include=FALSE}
# update survey object
options(survey.lonely.psu = "adjust")
des4 <- svydesign(ids = ~1, weights = ~weight, data = df2)

n0 <- svyglm(sick ~ Q11_1 + Q11_2 + Q11_3 + Q11_4 + Q11_5 + Q11_6 + Q11_7
             + Q11_8 + Q11_9 + Q11_10 + Q11_11, des4, family = quasibinomial())

summary(n0)
exp(coefficients(n0))




n1 <- svyglm(sick ~ q13, des4, family = quasibinomial())
n2 <- update(n1, ~ . + PPGENDER + PPETHM)
n3 <- update(n2, ~ . + ppagecat)
mtable(n1, n2, n3)


```


```{r, eval=FALSE, include=FALSE}
svyglm(sick ~ q13, des4, family = quasibinomial())

o1 <- svyglm(sick ~ q13, des4, family = quasibinomial())
o2 <- update(o1, ~ . + PPGENDER + PPETHM)
o3 <- update(o2, ~ . + ppagecat)
o4 <- update(o3, ~ . + ppagecat)
mtable(o1, o2, o3)

```


